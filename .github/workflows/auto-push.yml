name: Auto Push Skills to GitHub

on:
  push:
    branches: [ main, master ]
    paths:
      - 'scripts/**'
      - 'references/**'
      - 'assets/**'
      - 'SKILL.md'
      - 'README.md'
  workflow_dispatch:

jobs:
  auto-push:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Setup Git
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Actions"

    - name: Auto-commit skill changes
      run: |
        # Add all changed files
        git add scripts/ references/ assets/ SKILL.md README.md

        # Check if there are any changes to commit
        if git diff --cached --quiet; then
          echo "No changes to commit"
        else
          # Commit changes with a descriptive message
          git commit -m "Auto-update: $(date '+%Y-%m-%d %H:%M:%S') - Skills updated"

          # Push to the repository
          git push

          echo "Changes committed and pushed successfully"
        fi

    - name: Update package version
      run: |
        # Get current version from package.json or increment if exists
        if [ -f "package.json" ]; then
          node -e "
            const fs = require('fs');
            const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
            const version = pkg.version.split('.').map(Number);
            version[2]++;
            pkg.version = version.join('.');
            fs.writeFileSync('package.json', JSON.stringify(pkg, null, 2));
          "
          git add package.json
          git commit -m "chore: Bump version number" || echo "No version change needed"
          git push
        fi

    - name: Create Release
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: v${{ github.run_number }}
        release_name: Release v${{ github.run_number }}
        body: |
          ## Quality Problem Expert Skill Update

          ### Changes in this release:
          - Updated scripts and tools
          - Improved documentation
          - Enhanced functionality

          ### Files modified:
          - scripts/
          - references/
          - assets/
          - SKILL.md
          - README.md

          **Release Date:** $(date '+%Y-%m-%d')
          **Build Number:** ${{ github.run_number }}
        draft: false
        prerelease: false

    - name: Notify on failure
      if: failure()
      uses: actions/github-script@v7
      with:
        script: |
          core.setFailed('Auto-push workflow failed')

    - name: Summary
      if: success()
      run: |
        echo "## âœ… Auto-push completed successfully" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Changes detected and pushed:" >> $GITHUB_STEP_SUMMARY
        echo "- Updated skill scripts and tools" >> $GITHUB_STEP_SUMMARY
        echo "- Enhanced documentation" >> $GITHUB_STEP_SUMMARY
        echo "- Improved functionality" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Run ID:** ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
        echo "**Commit SHA:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "**Timestamp:** $(date)" >> $GITHUB_STEP_SUMMARY
